(()=>{"use strict";function e(){return JSON.parse(document.querySelector("script#liquid-variables").innerHTML)}const t=async(e,t)=>fetch(`https://karhu-b2b-functions.vercel.app/api${e}`,t).then((async e=>{const t=await(async e=>e.json().catch((e=>null)))(e);if(!e.ok||e.status>=400&&e.status<500&&404!==e.status)throw Error(t.message||"Something went wrong, please try again later.");return t})).catch((t=>{throw console.info(`⚡️⚠️ Function error [${e}]`),t}));function n(e=document.body,t){const n=[...e.querySelectorAll(t?`[class*="${t}"]`:"*")],o=t?"classList":"dataset";return n.reduce(((e,n)=>([].slice.call(t?n[o]:Object.entries(n[o])).forEach((o=>{let r;t&&o.slice(0,t.length)===t?r=o.slice(t.length,o.length):t||([r]=o),r&&(e[r]=e.hasOwnProperty(r)?e[r].constructor===Array?e[r].concat(n):[e[r],n]:n)})),e)),{})}const o="agent-stores:loading",r="selectedStoreCustomer",a="selectedShippingAddress",s="selectedBillingAddress",c=(window.component((async(c,d)=>{const i=localStorage.getItem(r);i&&d.emit("store:change",null,{id:i});const{store:{store:l},customer:{secret:u,id:m}}=e(),{selectCustomer:p}=n(c,null),{select:h}=n(p,null);d.on(o,((e,t=!0)=>{h.classList[t?"add":"remove"]("is-loading"),h.disabled=t})),d.emit(o,null,!0),h.addEventListener("change",(async e=>{const t=e.target.value,{countryCode:n}=e.target.options[e.target.selectedIndex].dataset;d.emit("cart:clear",null,{onCartClearSuccess:()=>((e,t)=>{localStorage.setItem(r,e),localStorage.removeItem(a),localStorage.removeItem(s),d.emit("store:change",null,{id:e}),d.emit("country:revalidate",null,{countryCode:t})})(t,n)})})),await(async()=>{const e=await(async(e,n,o)=>{const r=new URLSearchParams({store:e,customerId:n,secret:o});return t(`/customer/list-agent-stores?${r}`).catch((e=>(console.info("[unhandled error]"),[])))})(l,m,u);if(d.emit(o,null,!1),d.emit("agent-stores:received",null,{data:e}),!e.length)return void h.setAttribute("disabled",!0);(e=>{const t=document.createDocumentFragment();e.forEach((e=>{const n=document.createElement("option");i===e.id&&n.setAttribute("selected",!0),n.value=e.id,n.innerText=e.name,n.setAttribute("data-customer-select-option",""),n.setAttribute("data-country-code",e.countryCode||"NL"),t.appendChild(n)})),h.appendChild(t)})(e);const n=e.find((({id:e})=>e===i));if(!n){const{id:t}=e[0];return h.setAttribute("value",t),void h.dispatchEvent(new Event("change"))}d.emit("store:change",null,{id:n.id});const{countryCode:r}=n;r&&d.emit("country:revalidate",null,{countryCode:r})})()})),(e,t)=>t.map((t=>e.querySelector(t)))),d={bubbles:!0,cancelable:!1,detail:{shouldTriggerChange:!1}},i={checkout:window.component((n=>{const{skip_payment_discount_code:o,skip_payment_discount_applied:i,store:{store:l},customer:{secret:u,id:m}}=e(),[p,h]=c(n,[".order-summary__sections","[data-different-billing-address]"]),g=()=>{const e=e=>{localStorage.setItem(h?s:a,e)},[o,i]=c(n,["[data-address-selector]","[data-address-fields]"]);i&&(i.style.opacity="0.5",i.style.pointerEvents="none",Array.from(o.children).forEach((e=>{if(e.selected)return e.innerText="Please wait...",void e.removeAttribute("selected");e.remove()})),(async(e,n,o)=>{const a=new URLSearchParams({store:e,customerId:n,secret:o,storeId:localStorage.getItem(r)});return t(`/customer/get-store-customer-addresses?${a}`).catch((e=>(console.info("[unhandled error]"),[])))})(l,m,u).then((t=>((t,n)=>{const o=document.createDocumentFragment();n.forEach((t=>{o.appendChild((t=>{const n=document.createElement("option");n.value=t.id,n.innerText=(({address1:e,address2:t,zip:n,city:o,country:r,first_name:a,last_name:s,company:c})=>`${e?`${e}, `:" "}${t?`${t}, `:" "}${n?`${n} `:" "}${o?`${o}, `:" "}${r?`${r}, `:" "}${a||s||c?`${a?`${a} `:" "}${s?`${s}, `:" "}${c?`${c} `:""}`:""}`)(t),n.setAttribute("data-properties",JSON.stringify(t));const o=localStorage.getItem(a),r=localStorage.getItem(s),c=o?o===t.id:t.default,d=r?r===t.id:c;return(h?d:c)&&(n.selected=!0,e(t.id)),n})(t))})),t.appendChild(o),t.dispatchEvent(new CustomEvent("change",d)),t.firstElementChild.remove()})(o,t))).finally((()=>{i.style.opacity="1",i.style.pointerEvents="auto"})),i.addEventListener("change",(t=>{if(t.detail&&!t.detail.shouldTriggerChange)return;if(t.target.dataset.hasOwnProperty("addressSelector"))return void e(t.target.value);const n=localStorage.getItem(a),r=localStorage.getItem(s),c=h?r:n;c&&setTimeout((()=>(e=>{Array.from(o.children).find((t=>t.value===e)).selected=!0,o.dispatchEvent(new CustomEvent("change",d))})(c)))})))};g(),new MutationObserver((e=>{e.forEach((e=>{const{type:t,addedNodes:n}=e;"childList"===t&&n[0]&&n[0].dataset?.hasOwnProperty("step")&&g()}))})).observe(n,{childList:!0,subtree:!0});const y=()=>{const[e,t]=c(n,["[data-checkout-subtotal-price-target]",".total-line [data-checkout-payment-due-target]"]);t.innerText!==e.innerText&&(t.innerText=e.innerText)};if(y(),new MutationObserver((e=>{e.forEach((e=>{const{type:t,addedNodes:n}=e;"childList"===t&&n[0]&&(n[0].nodeType===Node.ELEMENT_NODE?n[0].querySelector("[data-checkout-payment-due-target]"):"checkoutPaymentDueTarget"in n[0].parentNode.dataset&&n[0].parentNode)&&y()}))})).observe(p,{childList:!0,subtree:!0}),!i){const[e,t]=c(n,['.order-summary__section--discount [name="checkout[reduction_code]"]','.order-summary__section--discount [name="checkout[submit]"]']);e.value=o,t.click()}})),paymentMethod:window.component((t=>{const{skip_payment_discount_applied:o}=e(),{paymentForm:r}=n(t);r.addEventListener("submit",(e=>{o||(e.preventDefault(),window.alert("Something went wrong, please reload the page and try again."),location.reload())}))}))};window.app.add(i),window.app.mount()})();